---
title: "Flu and general vaccine"
author: "Sihong"
date: "3/24/2021"
output: html_document
---

# 2. 2020-2021 Flu Vaccine
  * Survey question: Did you receive an influenza (Flu) vaccine for the 2019 flu season? - yes/no/unsure\
  * How likely are you to get a flu vaccination this season (2020-2021)—that is, this Fall or Winter? - Already received/Will definitely get one/Will probably get one/Will probably not get one/Will definitely not get one\
  * Did your child(ren) aged 0-5 receive an influenza (Flu) vaccine for the 2019 flu season?- yes/no/unsure\
  * How likely is/are your child(ren) aged 0-5 to get a flu vaccination this season (2020-2021)—that is, this Fall or Winter? -  Already received/Will definitely get one/Will probably get one/Will probably not get one/Will definitely not get one\

## 2.1 Most recent responses
### 2.1.1 Overall
```{r, echo=FALSE, message = FALSE, warning = FALSE}
vaccine_parent <- vaccine %>%
  filter (Week != 45)%>%
  group_by (CaregiverID)%>%
  filter (Week == max (Week))%>%
  ungroup ()%>%
  mutate (a.Already_got_vaccine = ifelse(HEALTH.016.a == 1 | HEALTH.016.b == 1, 1, 0), 
          b.Notyet_will_definitely_get = ifelse (HEALTH.016.b == 2, 1, 0), 
          c.Notyet_will_probably_get = ifelse (HEALTH.016.b == 3, 1, 0),
          d.Notyet_will_probably_not_get = ifelse (HEALTH.016.b == 4, 1, 0),
          e.Notyet_will_definitely_not_get = ifelse (HEALTH.016.b == 5, 1, 0))%>%
  summarise (n = n(),
             a.Already_got_vaccine = sum(a.Already_got_vaccine, na.rm = T)/n,
             b.Notyet_will_definitely_get = sum(b.Notyet_will_definitely_get, na.rm = T)/n,
             c.Notyet_will_probably_get = sum(c.Notyet_will_probably_get, na.rm = T)/n,
             d.Notyet_will_probably_not_get = sum(d.Notyet_will_probably_not_get, na.rm = T)/n,
             e.Notyet_will_definitely_not_get = sum(e.Notyet_will_definitely_not_get, na.rm = T)/n)%>%
   pivot_longer (cols = c("a.Already_got_vaccine", "b.Notyet_will_definitely_get", "c.Notyet_will_probably_get", "d.Notyet_will_probably_not_get", "e.Notyet_will_definitely_not_get"), names_to = "rsp", values_to = "prop")%>%
   mutate (count = prop * n, 
          moe = map2_dbl(prop, n, moe.p), 
          ci_low = prop-moe,
          ci_high = prop+moe, 
          who = "caregiver")

vaccine_child <- vaccine %>%
  filter (Week != 45)%>%
  group_by (CaregiverID)%>%
  filter (Week == max (Week))%>%
  ungroup ()%>%
  mutate (a.Already_got_vaccine = ifelse(HEALTH.017.a == 1 | HEALTH.017.b == 1, 1, 0), 
          b.Notyet_will_definitely_get = ifelse (HEALTH.017.b == 2, 1, 0), 
          c.Notyet_will_probably_get = ifelse (HEALTH.017.b == 3, 1, 0),
          d.Notyet_will_probably_not_get = ifelse (HEALTH.017.b == 4, 1, 0),
          e.Notyet_will_definitely_not_get = ifelse (HEALTH.017.b == 5, 1, 0))%>%
  summarise (n = n(),
             a.Already_got_vaccine = sum(a.Already_got_vaccine, na.rm = T)/n,
             b.Notyet_will_definitely_get = sum(b.Notyet_will_definitely_get, na.rm = T)/n,
             c.Notyet_will_probably_get = sum(c.Notyet_will_probably_get, na.rm = T)/n,
             d.Notyet_will_probably_not_get = sum(d.Notyet_will_probably_not_get, na.rm = T)/n,
             e.Notyet_will_definitely_not_get = sum(e.Notyet_will_definitely_not_get, na.rm = T)/n)%>%
   pivot_longer (cols = c("a.Already_got_vaccine", "b.Notyet_will_definitely_get", "c.Notyet_will_probably_get", "d.Notyet_will_probably_not_get", "e.Notyet_will_definitely_not_get"), names_to = "rsp", values_to = "prop")%>%
   mutate (count = prop * n, 
          moe = map2_dbl(prop, n, moe.p), 
          ci_low = prop-moe,
          ci_high = prop+moe, 
          who = "child")
  
vaccine_smy <- rbind (vaccine_parent, vaccine_child)         

vaccine_smy %>%
  ggplot(mapping = aes (x =  rsp, y = prop*100, fill = rsp)) +
  geom_bar (stat = "identity", position = position_dodge(1))+
  geom_errorbar(aes(ymin = ci_low*100, 
                    ymax = ci_high*100),
                    width = .3,
                    position = position_dodge(1)) +
  geom_text(aes(label = round(prop*100,2)),vjust = -1,hjust = 0.5, size = 2.5, color = "black",  position = position_dodge(1))+
  facet_wrap(~who, ncol = 2)+
  theme(axis.text.x = element_blank())
  

```

### 2.1.2 By race/ethnicity
```{r, echo=FALSE, message = FALSE, warning = FALSE}
vaccine_parent <- vaccine %>%
  filter (Week != 45)%>%
  group_by (CaregiverID)%>%
  filter (Week == max (Week))%>%
  ungroup ()%>%
  filter (race_ethnic!= "NA")%>%
  group_by (race_ethnic)%>%
  mutate (a.Already_got_vaccine = ifelse(HEALTH.016.a == 1 | HEALTH.016.b == 1, 1, 0), 
          b.Notyet_will_definitely_get = ifelse (HEALTH.016.b == 2, 1, 0), 
          c.Notyet_will_probably_get = ifelse (HEALTH.016.b == 3, 1, 0),
          d.Notyet_will_probably_not_get = ifelse (HEALTH.016.b == 4, 1, 0),
          e.Notyet_will_definitely_not_get = ifelse (HEALTH.016.b == 5, 1, 0))%>%
  summarise (n = n(),
             a.Already_got_vaccine = sum(a.Already_got_vaccine, na.rm = T)/n,
             b.Notyet_will_definitely_get = sum(b.Notyet_will_definitely_get, na.rm = T)/n,
             c.Notyet_will_probably_get = sum(c.Notyet_will_probably_get, na.rm = T)/n,
             d.Notyet_will_probably_not_get = sum(d.Notyet_will_probably_not_get, na.rm = T)/n,
             e.Notyet_will_definitely_not_get = sum(e.Notyet_will_definitely_not_get, na.rm = T)/n)%>%
   pivot_longer (cols = c("a.Already_got_vaccine", "b.Notyet_will_definitely_get", "c.Notyet_will_probably_get", "d.Notyet_will_probably_not_get", "e.Notyet_will_definitely_not_get"), names_to = "rsp", values_to = "prop")%>%
   mutate (count = prop * n, 
          moe = map2_dbl(prop, n, moe.p), 
          ci_low = prop-moe,
          ci_high = prop+moe, 
          who = "caregiver")

vaccine_child <- vaccine %>%
  filter (Week != 45)%>%
  group_by (CaregiverID)%>%
  filter (Week == max (Week))%>%
  ungroup ()%>%
  filter (race_ethnic!= "NA")%>%
  group_by (race_ethnic)%>%
  mutate (a.Already_got_vaccine = ifelse(HEALTH.017.a == 1 | HEALTH.017.b == 1, 1, 0), 
          b.Notyet_will_definitely_get = ifelse (HEALTH.017.b == 2, 1, 0), 
          c.Notyet_will_probably_get = ifelse (HEALTH.017.b == 3, 1, 0),
          d.Notyet_will_probably_not_get = ifelse (HEALTH.017.b == 4, 1, 0),
          e.Notyet_will_definitely_not_get = ifelse (HEALTH.017.b == 5, 1, 0))%>%
  summarise (n = n(),
             a.Already_got_vaccine = sum(a.Already_got_vaccine, na.rm = T)/n,
             b.Notyet_will_definitely_get = sum(b.Notyet_will_definitely_get, na.rm = T)/n,
             c.Notyet_will_probably_get = sum(c.Notyet_will_probably_get, na.rm = T)/n,
             d.Notyet_will_probably_not_get = sum(d.Notyet_will_probably_not_get, na.rm = T)/n,
             e.Notyet_will_definitely_not_get = sum(e.Notyet_will_definitely_not_get, na.rm = T)/n)%>%
   pivot_longer (cols = c("a.Already_got_vaccine", "b.Notyet_will_definitely_get", "c.Notyet_will_probably_get", "d.Notyet_will_probably_not_get", "e.Notyet_will_definitely_not_get"), names_to = "rsp", values_to = "prop")%>%
   mutate (count = prop * n, 
          moe = map2_dbl(prop, n, moe.p), 
          ci_low = prop-moe,
          ci_high = prop+moe, 
          who = "child")
  
vaccine_smy <- rbind (vaccine_parent, vaccine_child)         

vaccine_smy %>%
  ggplot(mapping = aes (x =  rsp, y = prop*100, fill = rsp)) +
  geom_bar (stat = "identity", position = position_dodge(1))+
  geom_errorbar(aes(ymin = ci_low*100, 
                    ymax = ci_high*100),
                    width = .3,
                    position = position_dodge(1)) +
  geom_text(aes(label = round(prop*100,2)),vjust = -1,hjust = 0.5, size = 2.5, color = "black",  position = position_dodge(1))+
  facet_wrap(who~race_ethnic, ncol = 3)+
  theme(axis.text.x = element_blank())

```

### 2.1.3 By poverty level
```{r, echo=FALSE, message = FALSE, warning = FALSE}
vaccine_parent <- vaccine %>%
  filter (Week != 45)%>%
  group_by (CaregiverID)%>%
  filter (Week == max (Week))%>%
  ungroup ()%>%
  filter (poverty_cat!= "NA")%>%
  group_by (poverty_cat)%>%
  mutate (a.Already_got_vaccine = ifelse(HEALTH.016.a == 1 | HEALTH.016.b == 1, 1, 0), 
          b.Notyet_will_definitely_get = ifelse (HEALTH.016.b == 2, 1, 0), 
          c.Notyet_will_probably_get = ifelse (HEALTH.016.b == 3, 1, 0),
          d.Notyet_will_probably_not_get = ifelse (HEALTH.016.b == 4, 1, 0),
          e.Notyet_will_definitely_not_get = ifelse (HEALTH.016.b == 5, 1, 0))%>%
  summarise (n = n(),
             a.Already_got_vaccine = sum(a.Already_got_vaccine, na.rm = T)/n,
             b.Notyet_will_definitely_get = sum(b.Notyet_will_definitely_get, na.rm = T)/n,
             c.Notyet_will_probably_get = sum(c.Notyet_will_probably_get, na.rm = T)/n,
             d.Notyet_will_probably_not_get = sum(d.Notyet_will_probably_not_get, na.rm = T)/n,
             e.Notyet_will_definitely_not_get = sum(e.Notyet_will_definitely_not_get, na.rm = T)/n)%>%
   pivot_longer (cols = c("a.Already_got_vaccine", "b.Notyet_will_definitely_get", "c.Notyet_will_probably_get", "d.Notyet_will_probably_not_get", "e.Notyet_will_definitely_not_get"), names_to = "rsp", values_to = "prop")%>%
   mutate (count = prop * n, 
          moe = map2_dbl(prop, n, moe.p), 
          ci_low = prop-moe,
          ci_high = prop+moe, 
          who = "caregiver")

vaccine_child <- vaccine %>%
  filter (Week != 45)%>%
  group_by (CaregiverID)%>%
  filter (Week == max (Week))%>%
  ungroup ()%>%
  filter (poverty_cat!= "NA")%>%
  group_by (poverty_cat)%>%
  mutate (a.Already_got_vaccine = ifelse(HEALTH.017.a == 1 | HEALTH.017.b == 1, 1, 0), 
          b.Notyet_will_definitely_get = ifelse (HEALTH.017.b == 2, 1, 0), 
          c.Notyet_will_probably_get = ifelse (HEALTH.017.b == 3, 1, 0),
          d.Notyet_will_probably_not_get = ifelse (HEALTH.017.b == 4, 1, 0),
          e.Notyet_will_definitely_not_get = ifelse (HEALTH.017.b == 5, 1, 0))%>%
  summarise (n = n(),
             a.Already_got_vaccine = sum(a.Already_got_vaccine, na.rm = T)/n,
             b.Notyet_will_definitely_get = sum(b.Notyet_will_definitely_get, na.rm = T)/n,
             c.Notyet_will_probably_get = sum(c.Notyet_will_probably_get, na.rm = T)/n,
             d.Notyet_will_probably_not_get = sum(d.Notyet_will_probably_not_get, na.rm = T)/n,
             e.Notyet_will_definitely_not_get = sum(e.Notyet_will_definitely_not_get, na.rm = T)/n)%>%
   pivot_longer (cols = c("a.Already_got_vaccine", "b.Notyet_will_definitely_get", "c.Notyet_will_probably_get", "d.Notyet_will_probably_not_get", "e.Notyet_will_definitely_not_get"), names_to = "rsp", values_to = "prop")%>%
   mutate (count = prop * n, 
          moe = map2_dbl(prop, n, moe.p), 
          ci_low = prop-moe,
          ci_high = prop+moe, 
          who = "child")
  
vaccine_smy <- rbind (vaccine_parent, vaccine_child)         

vaccine_smy %>%
  ggplot(mapping = aes (x =  rsp, y = prop*100, fill = poverty_cat)) +
  geom_bar (stat = "identity", position = position_dodge(1))+
  geom_errorbar(aes(ymin = ci_low*100, 
                    ymax = ci_high*100),
                    width = .3,
                    position = position_dodge(1)) +
  geom_text(aes(label = round(prop*100,2)),vjust = -1,hjust = 0.5, size = 2.5, color = "black",  position = position_dodge(1))+
  facet_wrap(~who, ncol = 2)+
  theme(axis.text.x = element_text(angle = 90))

```

### 2.1.4 By poverty level & race/ethnicity
```{r, echo=FALSE, message = FALSE, warning = FALSE}
vaccine_parent <- vaccine %>%
  filter (Week != 45)%>%
  group_by (CaregiverID)%>%
  filter (Week == max (Week))%>%
  ungroup ()%>%
  filter (poverty_cat!= "NA" & race_ethnic!= "NA")%>%
  group_by (poverty_cat, race_ethnic)%>%
  mutate (a.Already_got_vaccine = ifelse(HEALTH.016.a == 1 | HEALTH.016.b == 1, 1, 0), 
          b.Notyet_will_definitely_get = ifelse (HEALTH.016.b == 2, 1, 0), 
          c.Notyet_will_probably_get = ifelse (HEALTH.016.b == 3, 1, 0),
          d.Notyet_will_probably_not_get = ifelse (HEALTH.016.b == 4, 1, 0),
          e.Notyet_will_definitely_not_get = ifelse (HEALTH.016.b == 5, 1, 0))%>%
  summarise (n = n(),
             a.Already_got_vaccine = sum(a.Already_got_vaccine, na.rm = T)/n,
             b.Notyet_will_definitely_get = sum(b.Notyet_will_definitely_get, na.rm = T)/n,
             c.Notyet_will_probably_get = sum(c.Notyet_will_probably_get, na.rm = T)/n,
             d.Notyet_will_probably_not_get = sum(d.Notyet_will_probably_not_get, na.rm = T)/n,
             e.Notyet_will_definitely_not_get = sum(e.Notyet_will_definitely_not_get, na.rm = T)/n)%>%
   pivot_longer (cols = c("a.Already_got_vaccine", "b.Notyet_will_definitely_get", "c.Notyet_will_probably_get", "d.Notyet_will_probably_not_get", "e.Notyet_will_definitely_not_get"), names_to = "rsp", values_to = "prop")%>%
   mutate (count = prop * n, 
          moe = map2_dbl(prop, n, moe.p), 
          ci_low = prop-moe,
          ci_high = prop+moe, 
          who = "caregiver")

vaccine_child <- vaccine %>%
  filter (Week != 45)%>%
  group_by (CaregiverID)%>%
  filter (Week == max (Week))%>%
  ungroup ()%>%
  filter (poverty_cat!= "NA" & race_ethnic!= "NA")%>%
  group_by (poverty_cat, race_ethnic)%>%
  mutate (a.Already_got_vaccine = ifelse(HEALTH.017.a == 1 | HEALTH.017.b == 1, 1, 0), 
          b.Notyet_will_definitely_get = ifelse (HEALTH.017.b == 2, 1, 0), 
          c.Notyet_will_probably_get = ifelse (HEALTH.017.b == 3, 1, 0),
          d.Notyet_will_probably_not_get = ifelse (HEALTH.017.b == 4, 1, 0),
          e.Notyet_will_definitely_not_get = ifelse (HEALTH.017.b == 5, 1, 0))%>%
  summarise (n = n(),
             a.Already_got_vaccine = sum(a.Already_got_vaccine, na.rm = T)/n,
             b.Notyet_will_definitely_get = sum(b.Notyet_will_definitely_get, na.rm = T)/n,
             c.Notyet_will_probably_get = sum(c.Notyet_will_probably_get, na.rm = T)/n,
             d.Notyet_will_probably_not_get = sum(d.Notyet_will_probably_not_get, na.rm = T)/n,
             e.Notyet_will_definitely_not_get = sum(e.Notyet_will_definitely_not_get, na.rm = T)/n)%>%
   pivot_longer (cols = c("a.Already_got_vaccine", "b.Notyet_will_definitely_get", "c.Notyet_will_probably_get", "d.Notyet_will_probably_not_get", "e.Notyet_will_definitely_not_get"), names_to = "rsp", values_to = "prop")%>%
   mutate (count = prop * n, 
          moe = map2_dbl(prop, n, moe.p), 
          ci_low = prop-moe,
          ci_high = prop+moe, 
          who = "child")
  
vaccine_smy <- rbind (vaccine_parent, vaccine_child)         

vaccine_smy %>%
  ggplot(mapping = aes (x =  rsp, y = prop*100, fill = poverty_cat)) +
  geom_bar (stat = "identity", position = position_dodge(1))+
  geom_errorbar(aes(ymin = ci_low*100, 
                    ymax = ci_high*100),
                    width = .3,
                    position = position_dodge(1)) +
  geom_text(aes(label = round(prop*100,0)),vjust = -1,hjust = 0.5, size = 2, color = "black",  position = position_dodge(1))+
  facet_wrap(who~race_ethnic, ncol = 3)+
  theme(axis.text.x = element_text(angle = 90))


```

## 2.2 Trend
### 2.2.1 Overall
```{r, echo=FALSE, message = FALSE, warning = FALSE}
vaccine_parent <- vaccine %>%
  filter (Week != 45)%>%
  mutate (a.Already_got_vaccine = ifelse(HEALTH.016.a == 1 | HEALTH.016.b == 1, 1, 0), 
          b.Notyet_will_definitely_get = ifelse (HEALTH.016.b == 2, 1, 0), 
          c.Notyet_will_probably_get = ifelse (HEALTH.016.b == 3, 1, 0),
          d.Notyet_will_probably_not_get = ifelse (HEALTH.016.b == 4, 1, 0),
          e.Notyet_will_definitely_not_get = ifelse (HEALTH.016.b == 5, 1, 0))%>%
  group_by (Week)%>%
  summarise (n = n(),
             a.Already_got_vaccine = sum(a.Already_got_vaccine, na.rm = T)/n,
             b.Notyet_will_definitely_get = sum(b.Notyet_will_definitely_get, na.rm = T)/n,
             c.Notyet_will_probably_get = sum(c.Notyet_will_probably_get, na.rm = T)/n,
             d.Notyet_will_probably_not_get = sum(d.Notyet_will_probably_not_get, na.rm = T)/n,
             e.Notyet_will_definitely_not_get = sum(e.Notyet_will_definitely_not_get, na.rm = T)/n, 
             date = as.Date(min (StartDate)))%>%
   pivot_longer (cols = c("a.Already_got_vaccine", "b.Notyet_will_definitely_get", "c.Notyet_will_probably_get", "d.Notyet_will_probably_not_get", "e.Notyet_will_definitely_not_get"), names_to = "rsp", values_to = "prop")%>%
   mutate (count = prop * n, 
          moe = map2_dbl(prop, n, moe.p), 
          ci_low = prop-moe,
          ci_high = prop+moe, 
          who = "caregiver")

vaccine_child <- vaccine %>%
  filter (Week != 45)%>%
  mutate (a.Already_got_vaccine = ifelse(HEALTH.017.a == 1 | HEALTH.017.b == 1, 1, 0), 
          b.Notyet_will_definitely_get = ifelse (HEALTH.017.b == 2, 1, 0), 
          c.Notyet_will_probably_get = ifelse (HEALTH.017.b == 3, 1, 0),
          d.Notyet_will_probably_not_get = ifelse (HEALTH.017.b == 4, 1, 0),
          e.Notyet_will_definitely_not_get = ifelse (HEALTH.017.b == 5, 1, 0))%>%
  group_by (Week)%>%
  summarise (n = n(),
             a.Already_got_vaccine = sum(a.Already_got_vaccine, na.rm = T)/n,
             b.Notyet_will_definitely_get = sum(b.Notyet_will_definitely_get, na.rm = T)/n,
             c.Notyet_will_probably_get = sum(c.Notyet_will_probably_get, na.rm = T)/n,
             d.Notyet_will_probably_not_get = sum(d.Notyet_will_probably_not_get, na.rm = T)/n,
             e.Notyet_will_definitely_not_get = sum(e.Notyet_will_definitely_not_get, na.rm = T)/n, 
             date = as.Date(min (StartDate)))%>%
   pivot_longer (cols = c("a.Already_got_vaccine", "b.Notyet_will_definitely_get", "c.Notyet_will_probably_get", "d.Notyet_will_probably_not_get", "e.Notyet_will_definitely_not_get"), names_to = "rsp", values_to = "prop")%>%
   mutate (count = prop * n, 
          moe = map2_dbl(prop, n, moe.p), 
          ci_low = prop-moe,
          ci_high = prop+moe, 
          who = "child")
  
vaccine_smy <- rbind (vaccine_parent, vaccine_child)

date <- vaccine %>%
  group_by (Week)%>%
  summarise (date = min (StartDate))%>%
  ungroup()

vaccine_smy %>%
  ggplot(mapping = aes (x = date, y = prop*100, fill = rsp)) +
  geom_point(stat = 'summary') +
  geom_ribbon(aes(ymin = ci_low*100, ymax = ci_high*100), alpha = .3) +
  geom_line() +
  labs (y = "Percentage")+
  ggtitle(label = "Trend of changes")+
  facet_wrap(~who, nrow = 2)

```

### 2.2.2 By race/ethnicity
  * Categories "Not yet get and will probably get" & "Not yet get and will probably not get" are stable over time for all groups. Removed from grouping analyses so that figures are clearer.\
  
```{r, echo=FALSE, message = FALSE, warning = FALSE}
vaccine_parent <- vaccine %>%
  filter (Week != 45)%>%
  mutate (a.Already_got_vaccine = ifelse(HEALTH.016.a == 1 | HEALTH.016.b == 1, 1, 0), 
          b.Notyet_will_definitely_get = ifelse (HEALTH.016.b == 2, 1, 0), 
          #c.Notyet_will_probably_get = ifelse (HEALTH.016.b == 3, 1, 0),
          #d.Notyet_will_probably_not_get = ifelse (HEALTH.016.b == 4, 1, 0),
          e.Notyet_will_definitely_not_get = ifelse (HEALTH.016.b == 5, 1, 0))%>%
  filter (race_ethnic!= "NA")%>%
  group_by (Week, race_ethnic)%>%
  summarise (n = n(),
             a.Already_got_vaccine = sum(a.Already_got_vaccine, na.rm = T)/n,
             b.Notyet_will_definitely_get = sum(b.Notyet_will_definitely_get, na.rm = T)/n,
             #c.Notyet_will_probably_get = sum(c.Notyet_will_probably_get, na.rm = T)/n,
             #d.Notyet_will_probably_not_get = sum(d.Notyet_will_probably_not_get, na.rm = T)/n,
             e.Notyet_will_definitely_not_get = sum(e.Notyet_will_definitely_not_get, na.rm = T)/n, 
             date = as.Date(min (StartDate)))%>%
   pivot_longer (cols = c("a.Already_got_vaccine", "b.Notyet_will_definitely_get",  "e.Notyet_will_definitely_not_get"), names_to = "rsp", values_to = "prop")%>%
   mutate (count = prop * n, 
          moe = map2_dbl(prop, n, moe.p), 
          ci_low = prop-moe,
          ci_high = prop+moe, 
          who = "caregiver")

vaccine_child <- vaccine %>%
  filter (Week != 45)%>%
  mutate (a.Already_got_vaccine = ifelse(HEALTH.017.a == 1 | HEALTH.017.b == 1, 1, 0), 
          b.Notyet_will_definitely_get = ifelse (HEALTH.017.b == 2, 1, 0), 
          #c.Notyet_will_probably_get = ifelse (HEALTH.017.b == 3, 1, 0),
          #d.Notyet_will_probably_not_get = ifelse (HEALTH.017.b == 4, 1, 0),
          e.Notyet_will_definitely_not_get = ifelse (HEALTH.017.b == 5, 1, 0))%>%
  filter (race_ethnic!= "NA")%>%
  group_by (Week, race_ethnic)%>%
  summarise (n = n(),
             a.Already_got_vaccine = sum(a.Already_got_vaccine, na.rm = T)/n,
             b.Notyet_will_definitely_get = sum(b.Notyet_will_definitely_get, na.rm = T)/n,
             #c.Notyet_will_probably_get = sum(c.Notyet_will_probably_get, na.rm = T)/n,
             #d.Notyet_will_probably_not_get = sum(d.Notyet_will_probably_not_get, na.rm = T)/n,
             e.Notyet_will_definitely_not_get = sum(e.Notyet_will_definitely_not_get, na.rm = T)/n, 
             date = as.Date(min (StartDate)))%>%
   pivot_longer (cols = c("a.Already_got_vaccine", "b.Notyet_will_definitely_get",  "e.Notyet_will_definitely_not_get"), names_to = "rsp", values_to = "prop")%>%
   mutate (count = prop * n, 
          moe = map2_dbl(prop, n, moe.p), 
          ci_low = prop-moe,
          ci_high = prop+moe, 
          who = "child")
  
vaccine_smy <- rbind (vaccine_parent, vaccine_child)

date <- vaccine %>%
  group_by (Week)%>%
  summarise (date = min (StartDate))%>%
  ungroup()

vaccine_smy %>%
  ggplot(mapping = aes (x = date, y = prop*100, fill = rsp)) +
  #geom_point(stat = 'summary') +
  geom_ribbon(aes(ymin = ci_low*100, ymax = ci_high*100), alpha = .3) +
  geom_line() +
  labs (y = "Percentage")+
  ggtitle(label = "Trend of changes")+
  facet_wrap(who~race_ethnic, nrow = 2)

```

### 2.2.3 By poverty level
```{r, echo=FALSE, message = FALSE, warning = FALSE}
vaccine_parent <- vaccine %>%
  filter (Week != 45)%>%
  mutate (a.Already_got_vaccine = ifelse(HEALTH.016.a == 1 | HEALTH.016.b == 1, 1, 0), 
          b.Notyet_will_definitely_get = ifelse (HEALTH.016.b == 2, 1, 0), 
          #c.Notyet_will_probably_get = ifelse (HEALTH.016.b == 3, 1, 0),
          #d.Notyet_will_probably_not_get = ifelse (HEALTH.016.b == 4, 1, 0),
          e.Notyet_will_definitely_not_get = ifelse (HEALTH.016.b == 5, 1, 0))%>%
  filter (poverty_cat!= "NA")%>%
  group_by (Week, poverty_cat)%>%
  summarise (n = n(),
             a.Already_got_vaccine = sum(a.Already_got_vaccine, na.rm = T)/n,
             b.Notyet_will_definitely_get = sum(b.Notyet_will_definitely_get, na.rm = T)/n,
             #c.Notyet_will_probably_get = sum(c.Notyet_will_probably_get, na.rm = T)/n,
             #d.Notyet_will_probably_not_get = sum(d.Notyet_will_probably_not_get, na.rm = T)/n,
             e.Notyet_will_definitely_not_get = sum(e.Notyet_will_definitely_not_get, na.rm = T)/n, 
             date = as.Date(min (StartDate)))%>%
   pivot_longer (cols = c("a.Already_got_vaccine", "b.Notyet_will_definitely_get",  "e.Notyet_will_definitely_not_get"), names_to = "rsp", values_to = "prop")%>%
   mutate (count = prop * n, 
          moe = map2_dbl(prop, n, moe.p), 
          ci_low = prop-moe,
          ci_high = prop+moe, 
          who = "caregiver")

vaccine_child <- vaccine %>%
  filter (Week != 45)%>%
  mutate (a.Already_got_vaccine = ifelse(HEALTH.017.a == 1 | HEALTH.017.b == 1, 1, 0), 
          b.Notyet_will_definitely_get = ifelse (HEALTH.017.b == 2, 1, 0), 
          #c.Notyet_will_probably_get = ifelse (HEALTH.017.b == 3, 1, 0),
          #d.Notyet_will_probably_not_get = ifelse (HEALTH.017.b == 4, 1, 0),
          e.Notyet_will_definitely_not_get = ifelse (HEALTH.017.b == 5, 1, 0))%>%
  filter (poverty_cat!= "NA")%>%
  group_by (Week, poverty_cat)%>%
  summarise (n = n(),
             a.Already_got_vaccine = sum(a.Already_got_vaccine, na.rm = T)/n,
             b.Notyet_will_definitely_get = sum(b.Notyet_will_definitely_get, na.rm = T)/n,
             #c.Notyet_will_probably_get = sum(c.Notyet_will_probably_get, na.rm = T)/n,
             #d.Notyet_will_probably_not_get = sum(d.Notyet_will_probably_not_get, na.rm = T)/n,
             e.Notyet_will_definitely_not_get = sum(e.Notyet_will_definitely_not_get, na.rm = T)/n, 
             date = as.Date(min (StartDate)))%>%
   pivot_longer (cols = c("a.Already_got_vaccine", "b.Notyet_will_definitely_get",  "e.Notyet_will_definitely_not_get"), names_to = "rsp", values_to = "prop")%>%
   mutate (count = prop * n, 
          moe = map2_dbl(prop, n, moe.p), 
          ci_low = prop-moe,
          ci_high = prop+moe, 
          who = "child")
  
vaccine_smy <- rbind (vaccine_parent, vaccine_child)

date <- vaccine %>%
  group_by (Week)%>%
  summarise (date = min (StartDate))%>%
  ungroup()

vaccine_smy %>%
  ggplot(mapping = aes (x = date, y = prop*100, fill = rsp)) +
  #geom_point(stat = 'summary') +
  geom_ribbon(aes(ymin = ci_low*100, ymax = ci_high*100), alpha = .3) +
  geom_line() +
  labs (y = "Percentage")+
  ggtitle(label = "Trend of changes")+
  facet_wrap(who~poverty_cat, nrow = 2)

```


 
# 3. Delayed/Not getting Vaccine
  * Survey question: Have you ever delayed having your child get a shot for reasons other than illness or allergy? Select all that apply\
    + Yes, prior to the COVID-19 pandemic\
    + Yes, since the COVID-19 pandemic\
    + No\
    + I don't know\
  * Have you ever decided not to have your child get a shot for reasons other than illness or allergy? Select all that apply.\
    + Yes, prior to the COVID-19 pandemic\
    + Yes, since the COVID-19 pandemic\
    + No\
    + I don't know\

## 3.1 Overall
```{r, echo=FALSE, message = FALSE, warning = FALSE}
vaccine$HEALTH.020_4[is.na(vaccine$HEALTH.020_4)] <- 0
vaccine$HEALTH.021_4[is.na(vaccine$HEALTH.021_4)] <- 0

 vaccine_delay <- vaccine %>%
   filter (Week != 25 & Week != 27)%>%
   group_by (CaregiverID)%>%
   filter (Week == max (Week))%>%
   ungroup ()%>%
   filter (HEALTH.020_4 == 0)%>%
   summarise (n = n(),
              Yes_before_COVID = sum(HEALTH.020_1, na.rm = T)/n,
              Yes_since_COVID = sum(HEALTH.020_2, na.rm = T)/n,
              Never = sum(HEALTH.020_3, na.rm = T)/n)%>%
   pivot_longer (cols = c("Yes_before_COVID", "Yes_since_COVID", "Never"), names_to = "rsp", values_to = "prop")%>%
   mutate (count = prop * n, 
          moe = map2_dbl(prop, n, moe.p), 
          ci_low = prop-moe,
          ci_high = prop+moe, 
          action = "Delay Vaccine")
 
 vaccine_not <- vaccine %>%
   filter (Week != 25 & Week != 27)%>%
   group_by (CaregiverID)%>%
   filter (Week == max (Week))%>%
   ungroup ()%>%
   filter (HEALTH.021_4 == 0)%>%
   summarise (n = n(),
              Yes_before_COVID = sum(HEALTH.021_1, na.rm = T)/n,
              Yes_since_COVID = sum(HEALTH.021_2, na.rm = T)/n,
              Never = sum(HEALTH.021_3, na.rm = T)/n)%>%
   pivot_longer (cols = c("Yes_before_COVID", "Yes_since_COVID", "Never"), names_to = "rsp", values_to = "prop")%>%
   mutate (count = prop * n, 
          moe = map2_dbl(prop, n, moe.p), 
          ci_low = prop-moe,
          ci_high = prop+moe, 
          action = "Not Get Vaccine")
  
 vaccine_smy <- rbind (vaccine_delay, vaccine_not)         

vaccine_smy %>%
  ggplot(mapping = aes (x =  rsp, y = prop*100, fill = rsp)) +
  geom_bar (stat = "identity", position = position_dodge(1))+
  geom_errorbar(aes(ymin = ci_low*100, 
                    ymax = ci_high*100),
                    width = .3,
                    position = position_dodge(1)) +
  geom_text(aes(label = round(prop*100,2)),vjust = -1,hjust = 0.5, size = 3, color = "black",  position = position_dodge(1))+
  facet_wrap(~action, ncol = 2)+
  theme(axis.text.x = element_text(angle = 30))
```

## 3.2 By race/ethnicity
```{r, echo=FALSE, message = FALSE, warning = FALSE}
 vaccine_delay <- vaccine %>%
   filter (Week != 25 & Week != 27)%>%
   group_by (CaregiverID)%>%
   filter (Week == max (Week))%>%
   ungroup ()%>%
   filter (HEALTH.020_4 == 0 & race_ethnic != "NA")%>%
   group_by (race_ethnic)%>%
   summarise (n = n(),
              Yes_before_COVID = sum(HEALTH.020_1, na.rm = T)/n,
              Yes_since_COVID = sum(HEALTH.020_2, na.rm = T)/n,
              Never = sum(HEALTH.020_3, na.rm = T)/n)%>%
   pivot_longer (cols = c("Yes_before_COVID", "Yes_since_COVID", "Never"), names_to = "rsp", values_to = "prop")%>%
   mutate (count = prop * n, 
          moe = map2_dbl(prop, n, moe.p), 
          ci_low = prop-moe,
          ci_high = prop+moe, 
          action = "Delay Vaccine")
 
 vaccine_not <- vaccine %>%
   filter (Week != 25 & Week != 27)%>%
   group_by (CaregiverID)%>%
   filter (Week == max (Week))%>%
   ungroup ()%>%
   filter (HEALTH.021_4 == 0 & race_ethnic != "NA")%>%
   group_by (race_ethnic)%>%
   summarise (n = n(),
              Yes_before_COVID = sum(HEALTH.021_1, na.rm = T)/n,
              Yes_since_COVID = sum(HEALTH.021_2, na.rm = T)/n,
              Never = sum(HEALTH.021_3, na.rm = T)/n)%>%
   pivot_longer (cols = c("Yes_before_COVID", "Yes_since_COVID", "Never"), names_to = "rsp", values_to = "prop")%>%
   mutate (count = prop * n, 
          moe = map2_dbl(prop, n, moe.p), 
          ci_low = prop-moe,
          ci_high = prop+moe, 
          action = "Not Get Vaccine")
  
 vaccine_smy <- rbind (vaccine_delay, vaccine_not)         

vaccine_smy %>%
  ggplot(mapping = aes (x =  rsp, y = prop*100, fill = race_ethnic)) +
  geom_bar (stat = "identity", position = position_dodge(1))+
  geom_errorbar(aes(ymin = ci_low*100, 
                    ymax = ci_high*100),
                    width = .3,
                    position = position_dodge(1)) +
  geom_text(aes(label = round(prop*100,2)),vjust = -1,hjust = 0.5, size = 2.5, color = "black",  position = position_dodge(1))+
  facet_wrap(~action, ncol = 2)+
  theme(axis.text.x = element_text(angle = 30))
```
    
## 3.3 By poverty level
```{r, echo=FALSE, message = FALSE, warning = FALSE}
vaccine_delay <- vaccine %>%
   filter (Week != 25 & Week != 27)%>%
   group_by (CaregiverID)%>%
   filter (Week == max (Week))%>%
   ungroup ()%>%
   filter (HEALTH.020_4 == 0 & poverty_cat != "NA")%>%
   group_by (poverty_cat)%>%
   summarise (n = n(),
              Yes_before_COVID = sum(HEALTH.020_1, na.rm = T)/n,
              Yes_since_COVID = sum(HEALTH.020_2, na.rm = T)/n,
              Never = sum(HEALTH.020_3, na.rm = T)/n)%>%
   pivot_longer (cols = c("Yes_before_COVID", "Yes_since_COVID", "Never"), names_to = "rsp", values_to = "prop")%>%
   mutate (count = prop * n, 
          moe = map2_dbl(prop, n, moe.p), 
          ci_low = prop-moe,
          ci_high = prop+moe, 
          action = "Delay Vaccine")
 
 vaccine_not <- vaccine %>%
   filter (Week != 25 & Week != 27)%>%
   group_by (CaregiverID)%>%
   filter (Week == max (Week))%>%
   ungroup ()%>%
   filter (HEALTH.021_4 == 0 & poverty_cat != "NA")%>%
   group_by (poverty_cat)%>%
   summarise (n = n(),
              Yes_before_COVID = sum(HEALTH.021_1, na.rm = T)/n,
              Yes_since_COVID = sum(HEALTH.021_2, na.rm = T)/n,
              Never = sum(HEALTH.021_3, na.rm = T)/n)%>%
   pivot_longer (cols = c("Yes_before_COVID", "Yes_since_COVID", "Never"), names_to = "rsp", values_to = "prop")%>%
   mutate (count = prop * n, 
          moe = map2_dbl(prop, n, moe.p), 
          ci_low = prop-moe,
          ci_high = prop+moe, 
          action = "Not Get Vaccine")
  
 vaccine_smy <- rbind (vaccine_delay, vaccine_not)         

vaccine_smy %>%
  ggplot(mapping = aes (x =  rsp, y = prop*100, fill = poverty_cat)) +
  geom_bar (stat = "identity", position = position_dodge(1))+
  geom_errorbar(aes(ymin = ci_low*100, 
                    ymax = ci_high*100),
                    width = .3,
                    position = position_dodge(1)) +
  geom_text(aes(label = round(prop*100,2)),vjust = -1,hjust = 0.5, size = 2.5, color = "black",  position = position_dodge(1))+
  facet_wrap(~action, ncol = 2)+
  theme(axis.text.x = element_text(angle = 30))
```
  
## 3.4 By poverty level & race/ethnicity
```{r, echo=FALSE, message = FALSE, warning = FALSE}
vaccine_delay <- vaccine %>%
   filter (Week != 25 & Week != 27)%>%
   group_by (CaregiverID)%>%
   filter (Week == max (Week))%>%
   ungroup ()%>%
   filter (HEALTH.020_4 == 0 & poverty_cat != "NA" & race_ethnic != "NA")%>%
   group_by (poverty_cat, race_ethnic)%>%
   summarise (n = n(),
              Yes_before_COVID = sum(HEALTH.020_1, na.rm = T)/n,
              Yes_since_COVID = sum(HEALTH.020_2, na.rm = T)/n,
              Never = sum(HEALTH.020_3, na.rm = T)/n)%>%
   pivot_longer (cols = c("Yes_before_COVID", "Yes_since_COVID", "Never"), names_to = "rsp", values_to = "prop")%>%
   mutate (count = prop * n, 
          moe = map2_dbl(prop, n, moe.p), 
          ci_low = prop-moe,
          ci_high = prop+moe, 
          action = "Delay Vaccine")
 
 vaccine_not <- vaccine %>%
   filter (Week != 25 & Week != 27)%>%
   group_by (CaregiverID)%>%
   filter (Week == max (Week))%>%
   ungroup ()%>%
   filter (HEALTH.021_4 == 0 & poverty_cat != "NA" & race_ethnic != "NA")%>%
   group_by (poverty_cat, race_ethnic)%>%
   summarise (n = n(),
              Yes_before_COVID = sum(HEALTH.021_1, na.rm = T)/n,
              Yes_since_COVID = sum(HEALTH.021_2, na.rm = T)/n,
              Never = sum(HEALTH.021_3, na.rm = T)/n)%>%
   pivot_longer (cols = c("Yes_before_COVID", "Yes_since_COVID", "Never"), names_to = "rsp", values_to = "prop")%>%
   mutate (count = prop * n, 
          moe = map2_dbl(prop, n, moe.p), 
          ci_low = prop-moe,
          ci_high = prop+moe, 
          action = "Not Get Vaccine")
  
 vaccine_smy <- rbind (vaccine_delay, vaccine_not)         

vaccine_smy %>%
  ggplot(mapping = aes (x =  rsp, y = prop*100, fill = poverty_cat)) +
  geom_bar (stat = "identity", position = position_dodge(1))+
  geom_errorbar(aes(ymin = ci_low*100, 
                    ymax = ci_high*100),
                    width = .3,
                    position = position_dodge(1)) +
  geom_text(aes(label = round(prop*100,2)),vjust = -1,hjust = 0.5, size = 2.5, color = "black",  position = position_dodge(1))+
  facet_wrap(action~race_ethnic, ncol = 3)+
  theme(axis.text.x = element_text(angle = 30))
```
